ARG BUILDER_IMAGE=quay.io/kubevirt/builder:2510281240-82d14f4b41
ARG DISTROLESS_BASE_IMAGE=gcr.io/distroless/base-debian12:latest
ARG BUILD_ARCH=amd64

FROM ${BUILDER_IMAGE} AS builder

ARG BUILD_ARCH=amd64
ARG KUBEVIRT_VERSION

WORKDIR /workspace

COPY . .

# Generate handlerbase RPM tarball using Bazel
# Set KUBEVIRT_BOOTSTRAPPING=true to skip sandbox check in print-workspace-status.sh
RUN source /etc/profile.d/gimme.sh && \
    export KUBEVIRT_BOOTSTRAPPING=true && \
    case ${BUILD_ARCH} in \
        amd64|x86_64) BAZEL_ARCH="x86_64" ;; \
        arm64|aarch64|crossbuild-aarch64) BAZEL_ARCH="aarch64" ;; \
        s390x|crossbuild-s390x) BAZEL_ARCH="s390x" ;; \
        *) echo "ERROR: Unsupported BUILD_ARCH: ${BUILD_ARCH}"; exit 1 ;; \
    esac && \
    bazel build //rpm:handlerbase_${BAZEL_ARCH} && \
    mkdir -p /rootfs && \
    tar -xf bazel-bin/rpm/handlerbase_${BAZEL_ARCH}.tar -C /rootfs \
        --transform='s,^\./var/run/,./run/,x' \
        --overwrite && \
    ln -s ../run /rootfs/var/run

# Set PKG_CONFIG_PATH and LD_LIBRARY_PATH to use the RPM libraries
RUN source /etc/profile.d/gimme.sh && \
    export PKG_CONFIG_PATH="/rootfs/usr/lib64/pkgconfig:${PKG_CONFIG_PATH}" && \
    export C_INCLUDE_PATH="/rootfs/usr/include" && \
    export LIBRARY_PATH="/rootfs/usr/lib64" && \
    export CGO_CFLAGS="-I/rootfs/usr/include" && \
    export CGO_LDFLAGS="-L/rootfs/usr/lib64" && \
    BIN_NAME=virt-handler KUBEVIRT_NO_BAZEL=true hack/build-go.sh install cmd/virt-handler && \
    BIN_NAME=virt-chroot KUBEVIRT_NO_BAZEL=true hack/build-go.sh install cmd/virt-chroot

# Create passwd/group files
RUN echo "root:x:0:0:root:/root:/bin/bash" > /rootfs/etc/passwd && \
    echo "qemu:x:107:107:qemu:/home/qemu:/bin/bash" >> /rootfs/etc/passwd && \
    echo "root:x:0:" > /rootfs/etc/group && \
    echo "qemu:x:107:" >> /rootfs/etc/group

# Copy nsswitch.conf to rootfs
RUN cp /workspace/cmd/virt-handler/nsswitch.conf /rootfs/etc/nsswitch.conf

FROM ${DISTROLESS_BASE_IMAGE}

COPY --from=builder /rootfs/ /

COPY --from=builder /workspace/_out/cmd/virt-handler/virt-handler /usr/bin/virt-handler
COPY --from=builder /workspace/_out/cmd/virt-chroot/virt-chroot /usr/bin/virt-chroot

COPY --from=builder /workspace/.version /.version

ENTRYPOINT ["/usr/bin/virt-handler"]
