ARG BUILDER_IMAGE=quay.io/kubevirt/builder:2510281240-82d14f4b41
ARG DISTROLESS_BASE_IMAGE=gcr.io/distroless/base-debian12:latest

FROM ${BUILDER_IMAGE} AS builder

ARG BUILD_ARCH=amd64
ARG KUBEVIRT_VERSION

WORKDIR /workspace

COPY . .

RUN source /etc/profile.d/gimme.sh && \
    BIN_NAME=virt-operator KUBEVIRT_NO_BAZEL=true hack/build-go.sh install cmd/virt-operator && \
    BIN_NAME=csv-generator KUBEVIRT_NO_BAZEL=true hack/build-go.sh install tools/csv-generator

RUN echo "nonroot-user:x:1001:1001:nonroot user:/home/nonroot-user:/sbin/nologin" > /tmp/passwd

FROM ${DISTROLESS_BASE_IMAGE}

ARG BUILD_ARCH=amd64
ARG KUBEVIRT_VERSION

COPY --from=builder /workspace/_out/cmd/virt-operator/virt-operator /usr/bin/virt-operator
COPY --from=builder /workspace/_out/cmd/csv-generator/csv-generator /usr/bin/csv-generator

COPY --from=builder /workspace/.version /.version

COPY --from=builder --chmod=0644 /tmp/passwd /etc/passwd

USER 1001

ENTRYPOINT ["/usr/bin/virt-operator"]
