ARG BUILDER_IMAGE=quay.io/kubevirt/builder:2510281240-82d14f4b41
ARG DISTROLESS_BASE_IMAGE=gcr.io/distroless/base-debian12:latest
ARG BUILD_ARCH=amd64
ARG CENTOS_STREAM_VERSION=9

FROM ${BUILDER_IMAGE} AS builder

ARG BUILD_ARCH=amd64
ARG CENTOS_STREAM_VERSION=9
ARG KUBEVIRT_VERSION

WORKDIR /workspace
COPY . .

# Generate RPM tarballs using Bazel and extract to /rootfs
RUN source /etc/profile.d/gimme.sh && \
    export KUBEVIRT_BOOTSTRAPPING=true && \
    case ${BUILD_ARCH} in \
        amd64|x86_64) BAZEL_ARCH="x86_64" ;; \
        arm64|aarch64|crossbuild-aarch64) BAZEL_ARCH="aarch64" ;; \
        s390x|crossbuild-s390x) BAZEL_ARCH="s390x" ;; \
        *) echo "ERROR: Unsupported BUILD_ARCH: ${BUILD_ARCH}"; exit 1 ;; \
    esac && \
    bazel build --config=cs${CENTOS_STREAM_VERSION} //rpm:launcherbase_${BAZEL_ARCH} //rpm:libvirt-devel_${BAZEL_ARCH} && \
    mkdir -p /rootfs /rootfs/etc && \
    tar -xf bazel-bin/rpm/launcherbase_${BAZEL_ARCH}_cs${CENTOS_STREAM_VERSION}.tar -C /rootfs \
        --transform='s,^\./var/run/,./run/,x' --overwrite && \
    tar -xf bazel-bin/rpm/libvirt-devel_${BAZEL_ARCH}_cs${CENTOS_STREAM_VERSION}.tar -C /rootfs --overwrite && \
    ln -s ../run /rootfs/var/run

# Build Go binaries using libvirt from RPM tarball
# Use pkg-config files from libvirt-devel if they exist in /rootfs
RUN source /etc/profile.d/gimme.sh && \
    export PKG_CONFIG_PATH="/rootfs/usr/lib64/pkgconfig:${PKG_CONFIG_PATH}" && \
    export CGO_CFLAGS="-I/rootfs/usr/include" && \
    export CGO_LDFLAGS="-L/rootfs/usr/lib64" && \
    KUBEVIRT_NO_BAZEL=true hack/build-go.sh install \
    cmd/virt-launcher cmd/virt-launcher-monitor cmd/virt-freezer cmd/virt-probe cmd/virt-tail

# Build container-disk
RUN mkdir -p _out/cmd/container-disk-v2alpha && \
    gcc -static -o _out/cmd/container-disk-v2alpha/container-disk \
        cmd/container-disk-v2alpha/main.c && \
    chmod +x _out/cmd/container-disk-v2alpha/container-disk

# Set capabilities on virt-launcher-monitor
RUN VL_MONITOR_BIN=$(readlink -f _out/cmd/virt-launcher-monitor/virt-launcher-monitor) && \
    setcap cap_net_bind_service=+ep "$VL_MONITOR_BIN"

RUN echo "root:x:0:0:root:/root:/bin/bash" > /rootfs/etc/passwd && \
    echo "qemu:x:107:107:qemu:/home/qemu:/bin/bash" >> /rootfs/etc/passwd && \
    echo "root:x:0:" > /rootfs/etc/group && \
    echo "qemu:x:107:" >> /rootfs/etc/group

FROM ${DISTROLESS_BASE_IMAGE}

# Copy the RPM filesystem tree
COPY --from=builder /rootfs/ /

RUN chmod 755 /etc/libvirt

# Copy libvirt config files
COPY --from=builder --chmod=644 /workspace/cmd/virt-launcher/qemu.conf /etc/libvirt/qemu.conf
COPY --from=builder --chmod=644 /workspace/cmd/virt-launcher/virtqemud.conf /etc/libvirt/virtqemud.conf
COPY --from=builder --chmod=644 /workspace/cmd/virt-launcher/nsswitch.conf /etc/nsswitch.conf

COPY --from=builder /workspace/_out/cmd/virt-launcher/virt-launcher /usr/bin/virt-launcher
COPY --from=builder /workspace/_out/cmd/virt-launcher-monitor/virt-launcher-monitor /usr/bin/virt-launcher-monitor
COPY --from=builder /workspace/_out/cmd/virt-freezer/virt-freezer /usr/bin/virt-freezer
COPY --from=builder /workspace/_out/cmd/virt-probe/virt-probe /usr/bin/virt-probe
COPY --from=builder /workspace/_out/cmd/virt-tail/virt-tail /usr/bin/virt-tail
COPY --from=builder /workspace/_out/cmd/container-disk-v2alpha/container-disk /usr/bin/container-disk

COPY --from=builder /workspace/cmd/virt-launcher/node-labeller/node-labeller.sh /usr/bin/node-labeller.sh
COPY --from=builder /workspace/.version /.version

ENTRYPOINT ["/usr/bin/virt-launcher"]
