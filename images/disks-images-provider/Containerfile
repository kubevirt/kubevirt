ARG BUILDER_IMAGE=quay.io/kubevirt/builder:2510281240-82d14f4b41
ARG BUILD_ARCH=amd64
ARG TESTING_BASE_IMAGE=quay.io/kubevirt/kubevirt-testing-base:latest

FROM ${BUILDER_IMAGE} AS disk-builder
ARG BUILD_ARCH

WORKDIR /workspace

# Download alpine ISO based on architecture
RUN case ${BUILD_ARCH} in \
        amd64|x86_64) \
            curl -L -o /tmp/alpine.iso https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64/alpine-virt-3.20.1-x86_64.iso && \
            echo "f87a0fd3ab0e65d2a84acd5dad5f8b6afce51cb465f65dd6f8a3810a3723b6e4  /tmp/alpine.iso" | sha256sum -c - \
            ;; \
        arm64|aarch64|crossbuild-aarch64) \
            curl -L -o /tmp/alpine.iso https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/aarch64/alpine-virt-3.20.1-aarch64.iso && \
            echo "ca2f0e8aa7a1d7917bce7b9e7bd413772b64ec529a1938d20352558f90a5035a  /tmp/alpine.iso" | sha256sum -c - \
            ;; \
        s390x|crossbuild-s390x) \
            curl -L -o /tmp/alpine.iso https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/s390x/alpine-standard-3.18.8-s390x.iso && \
            echo "4ca1462252246d53e4949523b87fcea088e8b4992dbd6df792818c5875069b16  /tmp/alpine.iso" | sha256sum -c - \
            ;; \
        *) echo "ERROR: Unsupported BUILD_ARCH: ${BUILD_ARCH}"; exit 1 ;; \
    esac

RUN mkdir -p /workspace/images/alpine /workspace/images/custom && \
    cp /tmp/alpine.iso /workspace/images/alpine/disk.img && \
    truncate -s 64M /workspace/images/custom/disk.img

FROM ${TESTING_BASE_IMAGE}

COPY --from=disk-builder /workspace/images /images

COPY images/disks-images-provider/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
