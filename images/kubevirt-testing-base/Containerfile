ARG BUILD_ARCH=amd64

FROM quay.io/kubevirt/builder:2510281240-82d14f4b41 AS builder

ARG BUILD_ARCH

WORKDIR /workspace

COPY . .

# Build the testimage RPM tarball
RUN source /etc/profile.d/gimme.sh && \
    export KUBEVIRT_BOOTSTRAPPING=true && \
    case ${BUILD_ARCH} in \
        amd64|x86_64) BAZEL_ARCH="x86_64" ;; \
        arm64|aarch64|crossbuild-aarch64) BAZEL_ARCH="aarch64" ;; \
        s390x|crossbuild-s390x) BAZEL_ARCH="s390x" ;; \
        *) echo "ERROR: Unsupported BUILD_ARCH: ${BUILD_ARCH}"; exit 1 ;; \
    esac && \
    bazel build //rpm:testimage_${BAZEL_ARCH} && \
    mkdir -p /rootfs && \
    tar -xf bazel-bin/rpm/testimage_${BAZEL_ARCH}.tar -C /rootfs \
        --exclude='./var/run/*' && \
    if [ ! -L /rootfs/var/run ]; then \
        rm -rf /rootfs/var/run && \
        ln -s ../run /rootfs/var/run; \
    fi

RUN echo "root:x:0:0:root:/root:/bin/bash" > /rootfs/etc/passwd && \
    echo "nginx:x:101:101:nginx:/:/bin/bash" >> /rootfs/etc/passwd && \
    echo "root:x:0:" > /rootfs/etc/group && \
    echo "nginx:x:101:" >> /rootfs/etc/group

FROM scratch

ARG BUILD_ARCH
ARG KUBEVIRT_VERSION

COPY --from=builder /rootfs /
