apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: virt-handler
spec:
  template:
    metadata:
      name: virt-handler
      labels:
        daemon: virt-handler
    spec:
      serviceAccountName: kubevirt-infra
      hostPID: true
      initContainers:
      - name: containernetworking-cni-plugins
        image: rmohr/cni-plugins
        command: ['cp', '/plugins', '/tools', '-a']
        volumeMounts:
        - name: plugins
          mountPath: /tools/plugins
      - name: kubevirt-cni-plugin
        image: {{ docker_prefix }}/virt-handler:{{ docker_tag }}
        command: ['cp', '/plugins', '/tools', '-a']
        volumeMounts:
        - name: plugins
          mountPath: /tools/plugins
      containers:
      - name: dhcp
        image: {{ docker_prefix }}/virt-handler:{{ docker_tag }}
        command: ["/bin/sh", "-c"]
        args: ["rm -rf /run/cni/dhcp.sock && nsenter -t 1 -n /tools/plugins/dhcp daemon"]
        securityContext:
          privileged: true
        volumeMounts:
        - name: cni-run
          mountPath: /run/cni
        - name: plugins
          mountPath: /tools/plugins
      - name: virt-handler
        ports:
          - containerPort: 8185
            hostPort: 8185
        image: {{ docker_prefix }}/virt-handler:{{ docker_tag }}
        imagePullPolicy: IfNotPresent
        command:
          - "/virt-handler"
          - "-v"
          - "3"
          - "--libvirt-uri"
          - "qemu:///system"
          - "--hostname-override"
          - "$(NODE_NAME)"
        securityContext:
          privileged: true
        volumeMounts:
        - name: libvirt-runtime
          mountPath: /var/run/libvirt
        - name: virt-share-dir
          mountPath: /var/run/kubevirt
        - name: plugins
          mountPath: /tools/plugins
        - name: cni-run
          mountPath: /run/cni
        env:
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
      volumes:
      - name: libvirt-runtime
        hostPath:
          path: /var/run/libvirt
      - name: virt-share-dir
        hostPath:
          path: /var/run/kubevirt
      - name: plugins
        emptyDir: {}
      - name: cni-run
        emptyDir: {}
